<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#4fc08d"><meta name="msapplication-TileColor" content="#4fc08d"><title> nginx反代+http2配置 · Just4fun</title><meta name="description" content="nginx反代+http2配置 - coolrc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://coolrc.me/atom.xml" title="Just4fun"><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-71864657-1",'auto');ga('send','pageview');</script><script src="//code.jquery.com/jquery-2.2.0.min.js"></script><link rel="stylesheet" href="/css/jquery.fancybox.min.css"><script src="/js/jquery.fancybox.min.js"></script><script src="/js/wrapimage.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Just4fun" type="application/atom+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/avatar.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="/friends/" target="_self">LINKS</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/coolrc136" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">nginx反代+http2配置</h1><div class="post-info">Oct 12, 2016</div><div class="post-content"><p><img src="https://c1.staticflickr.com/9/8640/30280932405_35376236c5_z_d.jpg" alt="http2"></p>
<p>国庆节回家没事干，研究了一下nginx配置，参考了 Jerry Qu的文章 <a target="_blank" rel="noopener" href="https://imququ.com/post/my-nginx-conf.html">本博客 Nginx 配置之完整篇</a>,给我的 github pages 用nginx做了一个反代，顺便开启了 http/2 支持。<span id="more"></span>下面开始配置过程。</p>
<p>操作系统我选择的是 ubuntu 16.04 ，其他发行版请自行修改命令。</p>
<h3 id="安装并编译相关软件"><a href="#安装并编译相关软件" class="headerlink" title="安装并编译相关软件"></a>安装并编译相关软件</h3><p>首先安装依赖和编译工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential libpcre3 libpcre3-dev zlib1g-dev unzip git</span><br></pre></td></tr></table></figure>

<h4 id="Brotli压缩支持"><a href="#Brotli压缩支持" class="headerlink" title="Brotli压缩支持"></a>Brotli压缩支持</h4><p>编译安装 <a target="_blank" rel="noopener" href="https://github.com/google/brotli">libbrotli</a>,使用 Brotli 压缩格式可以实现更高的网页压缩比。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install autoconf libtool automake</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/bagder/libbrotli</span><br><span class="line"><span class="built_in">cd</span> libbrotli</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果提示 error: C source seen but &#x27;CC&#x27; is undefined，可以在 configure.ac 最后加上 AC_PROG_CC</span></span><br><span class="line">./autogen.sh</span><br><span class="line"></span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span>  ../</span><br></pre></td></tr></table></figure>

<p>接下来获取 ngx_brotli 源码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/google/ngx_brotli.git</span><br></pre></td></tr></table></figure>

<h4 id="安装-openssl"><a href="#安装-openssl" class="headerlink" title="安装 openssl"></a>安装 openssl</h4><p>系统自带的openssl太旧，需要自行编译最新版。这里安装 openssl 1.1.0b</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O openssl.tar.gz -c https://www.openssl.org/<span class="built_in">source</span>/openssl-1.1.0b.tar.gz</span><br><span class="line">tar zxf openssl.tar.gz</span><br><span class="line">mv openssl-1.1.0b/ openssl</span><br></pre></td></tr></table></figure>

<h4 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget -c https://nginx.org/download/nginx-1.11.4.tar.gz</span><br><span class="line">tar zxf nginx-1.11.4.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> nginx-1.11.4/</span><br><span class="line"></span><br><span class="line">./configure --add-module=../ngx_brotli --add-module=../nginx-ct-1.3.0 --with-openssl=../openssl --with-http_v2_module --with-http_ssl_module --with-ipv6 --with-http_gzip_static_module</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h4 id="Nginx管理脚本"><a href="#Nginx管理脚本" class="headerlink" title="Nginx管理脚本"></a>Nginx管理脚本</h4><p>由于nginx是自己编译的，无法使用 systemd 管理，这里用一个脚本进行管理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### BEGIN INIT INFO</span></span><br><span class="line"><span class="comment"># Provides:          nginx</span></span><br><span class="line"><span class="comment"># Required-Start:    $all</span></span><br><span class="line"><span class="comment"># Required-Stop:     $all</span></span><br><span class="line"><span class="comment"># Default-Start:     2 3 4 5</span></span><br><span class="line"><span class="comment"># Default-Stop:      0 1 6</span></span><br><span class="line"><span class="comment"># Short-Description: starts the nginx web server</span></span><br><span class="line"><span class="comment"># Description:       starts nginx using start-stop-daemon</span></span><br><span class="line"><span class="comment">### END INIT INFO</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/usr/<span class="built_in">local</span>/lib:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">DAEMON=/usr/<span class="built_in">local</span>/nginx/sbin/nginx</span><br><span class="line">NAME=nginx</span><br><span class="line">DESC=nginx</span><br><span class="line"></span><br><span class="line"><span class="built_in">test</span> -x <span class="variable">$DAEMON</span> || <span class="built_in">exit</span> 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Include nginx defaults if available</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/default/nginx ] ; <span class="keyword">then</span></span><br><span class="line">  . /etc/default/nginx</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">. /lib/lsb/init-functions</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">  start)</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;Starting <span class="variable">$DESC</span>: &quot;</span></span><br><span class="line">    start-stop-daemon --start --quiet --pidfile /usr/<span class="built_in">local</span>/nginx/logs/<span class="variable">$NAME</span>.pid \</span><br><span class="line">        --<span class="built_in">exec</span> <span class="variable">$DAEMON</span> -- <span class="variable">$DAEMON_OPTS</span> || <span class="literal">true</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$NAME</span>.&quot;</span></span><br><span class="line">    ;;</span><br><span class="line">  stop)</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;Stopping <span class="variable">$DESC</span>: &quot;</span></span><br><span class="line">    start-stop-daemon --stop --quiet --pidfile /usr/<span class="built_in">local</span>/nginx/logs/<span class="variable">$NAME</span>.pid \</span><br><span class="line">        --<span class="built_in">exec</span> <span class="variable">$DAEMON</span> || <span class="literal">true</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$NAME</span>.&quot;</span></span><br><span class="line">    ;;</span><br><span class="line">  restart|force-reload)</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;Restarting <span class="variable">$DESC</span>: &quot;</span></span><br><span class="line">    start-stop-daemon --stop --quiet --pidfile \</span><br><span class="line">        /usr/<span class="built_in">local</span>/nginx/logs/<span class="variable">$NAME</span>.pid --<span class="built_in">exec</span> <span class="variable">$DAEMON</span> || <span class="literal">true</span></span><br><span class="line">    sleep 1</span><br><span class="line">    start-stop-daemon --start --quiet --pidfile \</span><br><span class="line">        /usr/<span class="built_in">local</span>/nginx/logs/<span class="variable">$NAME</span>.pid --<span class="built_in">exec</span> <span class="variable">$DAEMON</span> -- <span class="variable">$DAEMON_OPTS</span> || <span class="literal">true</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$NAME</span>.&quot;</span></span><br><span class="line">    ;;</span><br><span class="line">  reload)</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;Reloading <span class="variable">$DESC</span> configuration: &quot;</span></span><br><span class="line">    start-stop-daemon --stop --signal HUP --quiet --pidfile /usr/<span class="built_in">local</span>/nginx/logs/<span class="variable">$NAME</span>.pid \</span><br><span class="line">        --<span class="built_in">exec</span> <span class="variable">$DAEMON</span> || <span class="literal">true</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$NAME</span>.&quot;</span></span><br><span class="line">    ;;</span><br><span class="line">  status)</span><br><span class="line">    status_of_proc -p /usr/<span class="built_in">local</span>/nginx/logs/<span class="variable">$NAME</span>.pid <span class="string">&quot;<span class="variable">$DAEMON</span>&quot;</span> nginx &amp;&amp; <span class="built_in">exit</span> 0 || <span class="built_in">exit</span> $?</span><br><span class="line">    ;;</span><br><span class="line">  *)</span><br><span class="line">    N=/etc/init.d/<span class="variable">$NAME</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$N</span> &#123;start|stop|restart|reload|force-reload|status&#125;&quot;</span> &gt;&amp;2</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">    ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<p>将这个脚本放到任何位置，加上执行权限即可。</p>
<p>现在管理 Nginx 只需使用以下命令即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ./nginx start|stop|restart|reload</span><br></pre></td></tr></table></figure>

<p>如果要开机自动启动 Nginx，请执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-rc.d -f nginx defaults</span><br></pre></td></tr></table></figure>

<p>然后配置 nginx 的配置文件 <code>/usr/local/nginx/conf/nginx.conf</code>，将http部分修改成下面这样</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>            mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>       application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">charset</span>            UTF-<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>           <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nopush</span>         <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nodelay</span>        <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">60</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#... ...#</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">gzip</span>               <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_vary</span>          <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">gzip_comp_level</span>    <span class="number">6</span>;</span><br><span class="line">    <span class="attribute">gzip_buffers</span>       <span class="number">16</span> <span class="number">8k</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">gzip_min_length</span>    <span class="number">1000</span>;</span><br><span class="line">    <span class="attribute">gzip_proxied</span>       any;</span><br><span class="line">    <span class="attribute">gzip_disable</span>       <span class="string">&quot;msie6&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">gzip_http_version</span>  <span class="number">1</span>.<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">gzip_types</span>         text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript image/svg+xml;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果编译时添加了 ngx_brotli 模块，需要增加 brotli 相关配置</span></span><br><span class="line">    <span class="attribute">brotli</span>             <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">brotli_comp_level</span>  <span class="number">6</span>;</span><br><span class="line">    <span class="attribute">brotli_types</span>       text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript image/svg+xml;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#... ...#</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span>            /home/jerry/www/nginx_conf/<span class="regexp">*.conf</span>; <span class="comment">#站点配置文件地址，可以自行指定</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="生成-https-证书"><a href="#生成-https-证书" class="headerlink" title="生成 https 证书"></a>生成 https 证书</h3><p>这里使用 <a target="_blank" rel="noopener" href="https://github.com/lukas2511/dehydrated">dehydrated</a> 来自动申请 <a target="_blank" rel="noopener" href="https://letsencrypt.org/">Let’s Encrypt</a> 的证书。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/lukas2511/dehydrated.git</span><br><span class="line"><span class="built_in">cd</span> dehydrated</span><br></pre></td></tr></table></figure>

<p>然后在 dehydrated 新建一个 <code>domains.txt</code> ，里面填入你的域名，例如</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">example.com www.example.com</span><br><span class="line">example.net www.example.net wiki.example.net</span><br></pre></td></tr></table></figure>

<p>然后新建一个 nginx 站点配置文件，内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;                                                                    </span><br><span class="line">         listen   80; ## 监听 IPv4 80 端口</span><br><span class="line">         server_name example.com www.example.com;</span><br><span class="line">         location /.well-known/acme-challenge &#123;</span><br><span class="line">           alias /var/www/dehydrated;</span><br><span class="line">         &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动 nginx ，保证域名能解析到本机。</p>
<p>创建文件夹 /var/www/dehydrated 更改目录权限为 777 。</p>
<p>修改 dehydrated 代码，使他支持生成 ECC 证书，修改 <code>dehydreted</code> 文件，修改其中121行变量 KEY_ALGO 值为 <code>secp384r1</code> ，</p>
<p>然后就可以生成证书了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./dehydrated -c</span><br></pre></td></tr></table></figure>

<p>软件会自动生成各种密钥并申请证书，完成后各种文件都在 <code>certs</code> 文件夹里保存。</p>
<p>然后再生成一个赫尔曼密钥，使用<code>openssl dhparam -out dhparam.pem 2048</code>生成，你也可以将 2048 改成 4096 ，但是这样会耗费你几个小时的时间来生成，而 2048 只需要几分钟。</p>
<p>然后就可以将前面创建的 nginx 站点配置文件移走，或者更改掉后缀名让nginx不读取。</p>
<p>但是不要删除，因为 Let’s Encrypt 的证书有效期只有 90 天，官方建议每 60 天重新生成一次，下次生成还是要这个配置文件。</p>
<h3 id="配置-Nginx"><a href="#配置-Nginx" class="headerlink" title="配置 Nginx"></a>配置 Nginx</h3><p>将前面创建的站点配置文件后缀更改为其他样式，新建一个配置文件</p>
<p>内容类似这样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen   80; ## 监听 IPv4 80 端口</span><br><span class="line">        server_name example.com www.example.com;</span><br><span class="line">        server_tokens   off;#隐藏服务器信息</span><br><span class="line">        add_header Strict-Transport-Security &quot;max-age=63072000; includeSubdomains; preload&quot;;#HSTS</span><br><span class="line">        rewrite ^/(.*)$ https://coolrc.top/$1 permanent; #重定向到http</span><br><span class="line">        #减少点击劫持</span><br><span class="line">        add_header X-Frame-Options DENY;</span><br><span class="line">        #禁止服务器自动解析资源类型</span><br><span class="line">        add_header X-Content-Type-Options nosniff;</span><br><span class="line">        #防XSS攻擊</span><br><span class="line">        add_header X-Xss-Protection 1;</span><br><span class="line">         location / &#123;</span><br><span class="line">                ## 这里用 HTTPS 比较好，代理服务器和源服务器间也是加密通讯</span><br><span class="line">                proxy_pass http://coolrc136.github.io/; #我的博客地址，这里使用https会出问题</span><br><span class="line">                proxy_set_header Accept-Encoding &quot;&quot;;</span><br><span class="line">                proxy_redirect     off;</span><br><span class="line">                proxy_set_header   Host                       $host;</span><br><span class="line">                proxy_set_header   X-Real-IP               $remote_addr;</span><br><span class="line">                proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen   443 ssl http2; ## listen for ipv4; this line is default and implied</span><br><span class="line"></span><br><span class="line">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2; #禁止不安全的协议</span><br><span class="line">        ssl_ciphers                EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;</span><br><span class="line">        ssl on;</span><br><span class="line">        server_tokens   off;</span><br><span class="line">        server_name example.com www.example.com;</span><br><span class="line">      	ssl_prefer_server_ciphers  on;</span><br><span class="line">      	ssl_stapling               on;</span><br><span class="line">      	ssl_stapling_verify        on;</span><br><span class="line">        ## 这里路径为 fullchain.pem 文件的路径，文件可以随意放，确保位置正确即可</span><br><span class="line">        ssl_certificate /root/www/certs/fullchain.pem;</span><br><span class="line">        ## 这里路径 和 fullchain.pem 文件的路径作用一样</span><br><span class="line">        ##赫尔曼密钥,使用openssl dhparam -out dhparam.pem 2048命令生成</span><br><span class="line">        ssl_dhparam /root/www/certs/dhparam.pem;</span><br><span class="line">        #减少点击劫持</span><br><span class="line">        add_header X-Frame-Options DENY;</span><br><span class="line">        #禁止服务器自动解析资源类型</span><br><span class="line">        add_header X-Content-Type-Options nosniff;</span><br><span class="line">        #防XSS攻擊</span><br><span class="line">        add_header X-Xss-Protection 1;</span><br><span class="line">         location /.well-known/acme-challenge &#123;</span><br><span class="line">           alias /var/www/dehydrated;</span><br><span class="line">         &#125;</span><br><span class="line">         location / &#123;</span><br><span class="line">                ## 这里用 HTTPS 比较好，代理服务器和源服务器间也是加密通讯</span><br><span class="line">                proxy_pass http://coolrc136.github.io; #这里使用https会出问题</span><br><span class="line">                proxy_set_header Accept-Encoding &quot;&quot;;</span><br><span class="line">                proxy_set_header X-Real_IP $remote_addr;</span><br><span class="line">                proxy_set_header User-Agent $http_user_agent;</span><br><span class="line">                proxy_set_header referer &quot;http://coolrc136.github.io$request_uri&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里要注意的是，github pages 是支持 https 的，而且使用 https 会更安全，但是我将上游的网址填成 https 网址的话，网页会有时候直接跳转到上游的地址，绕过代理。</p>
<p>至此，博客反代配置成功，支持 http/2 ，使用 ECC 证书，支持 ALPN，在手机平台使用 chacha20 加密连接，pc平台使用 aes 加密，节省了性能。</p>
<p>但是正是由于这些新特性，博客仅支持新版本浏览器，比如 IE11 以下就是不能访问博客的，如果你的访问者大多使用旧版的浏览器，你需要慎重考虑是否要这样配置。</p>
<hr>
<p>参考资料：</p>
<p><a target="_blank" rel="noopener" href="https://imququ.com/post/letsencrypt-certificate.html">https://imququ.com/post/letsencrypt-certificate.html</a><br><a target="_blank" rel="noopener" href="https://imququ.com/post/my-nginx-conf.html">https://imququ.com/post/my-nginx-conf.html</a><br><a target="_blank" rel="noopener" href="https://aotu.io/notes/2016/08/16/nginx-https/">https://aotu.io/notes/2016/08/16/nginx-https/</a></p>
</div><div class="post-info">last updated: Oct 19, 2016</div><a class="post-info" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">许可协议: "署名-非商用-相同方式共享 4.0" 转载请保留原文链接及作者。</a></article></div></section><footer><nav id="pagination"><a class="prev" href="/2016/11/24/24063358/"><span>解决konsole无法输入中文的问题</span></a><a class="prev" href="/2016/09/18/18231939/"><span>校园网使用ipv6的SS免流</span></a></nav><div class="copyright"><span id="jinrishici-sentence">正在加载今日诗词....</span><script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js"></script><p>© 2015 - 2021 <a href="https://coolrc.me">coolrc</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div></body></html>