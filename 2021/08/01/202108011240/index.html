<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#4fc08d"><meta name="msapplication-TileColor" content="#4fc08d"><title> Spring Data多数据源冲突问题 · Just4fun</title><meta name="description" content="Spring Data多数据源冲突问题 - coolrc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://coolrc.me/atom.xml" title="Just4fun"><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-71864657-1",'auto');ga('send','pageview');</script><script src="//code.jquery.com/jquery-2.2.0.min.js"></script><link rel="stylesheet" href="/css/jquery.fancybox.min.css"><script src="/js/jquery.fancybox.min.js"></script><script src="/js/wrapimage.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Just4fun" type="application/atom+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/avatar.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="/friends/" target="_self">LINKS</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/coolrc136" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Spring Data多数据源冲突问题</h1><div class="post-info">Aug 1, 2021</div><div class="post-content"><span id="more"></span>

<h2 id="不同数据源冲突"><a href="#不同数据源冲突" class="headerlink" title="不同数据源冲突"></a>不同数据源冲突</h2><p>在spring里面配置了两个以上数据源的时候，可能会出现报错，例如我配置了ES和Mongo两个数据源，就会这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The bean &#x27;xxxxEsRepository&#x27;, defined in xx.repositories.xxEsRepository defined in @EnableMongoRepositories declared on xxApplication, could not be registered. A bean with that name has already been defined in me.xxx.repositories.xxxEsRepository defined in @EnableElasticsearchRepositories declared on xxApplication and overriding is disabled.</span><br></pre></td></tr></table></figure>

<p>一段报错里出现了<code>@EnableMongoRepositories</code>和<code>@EnableElasticsearchRepositories</code>两个注解，意思就是Repository的bean冲突了。</p>
<p>由于我们的<code>@EnableElasticsearchRepositories</code>写在前面，所以所有标注了<code>@@Repository</code>的都被作为ES的repo注入了，接下来<code>@EnableMongoRepositories</code>还会再做同样的事情，每个bean都被注册了两次，就冲突了。</p>
<p>这个时候，就要我们手动来指定哪个配置对应哪个repo了，手动指定两个配置对应的repo就行了。</p>
<p>原来的@Enable注解修改一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// before</span></span><br><span class="line"><span class="meta">@EnableElasticsearchRepositories</span></span><br><span class="line"><span class="meta">@EnableMongoRepositories</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// after</span></span><br><span class="line"><span class="meta">@EnableElasticsearchRepositories(</span></span><br><span class="line"><span class="meta">    includeFilters = [ComponentScan.Filter(type = FilterType.REGEX, pattern = [&quot;.*EsRepository&quot;])]</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@EnableMongoRepositories(</span></span><br><span class="line"><span class="meta">    includeFilters = [ComponentScan.Filter(type = FilterType.REGEX, pattern = [&quot;.*MongoRepository&quot;])])</span></span><br></pre></td></tr></table></figure>

<p>只要加一个includeFilters，指定你要用哪个repo的类就行了，当然，你也可以用<code>excludeFilters</code>排除不相干的类。这里用<code>basePackageClasses</code>没有用，暂时不知道为啥。</p>
<h2 id="同一个数据源不同数据库"><a href="#同一个数据源不同数据库" class="headerlink" title="同一个数据源不同数据库"></a>同一个数据源不同数据库</h2><p>还有另外一种常见操作是，在同一个数据源里面我们要请求不同的数据库，或者不同服务器。这个时候还是类似上面的操作。</p>
<p>因为有两个Configuration，所以要注解两次，这时候优先使用Java配置：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(<span class="meta-string">&quot;primary&quot;</span>)</span></span><br><span class="line"><span class="meta">@EnableMongoRepositories(basePackageClasses = [ChatMessageMongoRepository::class],</span></span><br><span class="line"><span class="meta">    basePackages = [<span class="meta-string">&quot;me.coolrc.chatlog.repositories.mongo.chat_message&quot;</span>],</span></span><br><span class="line"><span class="meta">    mongoTemplateRef = <span class="meta-string">&quot;primary-template&quot;</span></span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MongoConfigPrimary</span> : <span class="type">AbstractMongoClientConfiguration</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(<span class="meta-string">&quot;primary-database&quot;</span>)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix=<span class="meta-string">&quot;spring.database&quot;</span>)</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getDatabaseName</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;chatlog&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean(<span class="meta-string">&quot;primary-template&quot;</span>)</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">mongoTemplate</span><span class="params">(databaseFactory: <span class="type">MongoDatabaseFactory</span>, converter: <span class="type">MappingMongoConverter</span>)</span></span>: MongoTemplate &#123;</span><br><span class="line">        <span class="keyword">return</span> MongoTemplate(mongoClient(),databaseName)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(<span class="meta-string">&quot;primary-client&quot;</span>)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix=<span class="meta-string">&quot;spring.client&quot;</span>)</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">mongoClient</span><span class="params">()</span></span>: MongoClient &#123;</span><br><span class="line">        <span class="keyword">return</span> MongoClients.create(<span class="string">&quot;mongodb://root:example@localhost:27017&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration(<span class="meta-string">&quot;second&quot;</span>)</span></span><br><span class="line"><span class="meta">@EnableMongoRepositories(basePackageClasses = [UserMongoRepository::class],</span></span><br><span class="line"><span class="meta">    basePackages = [<span class="meta-string">&quot;me.coolrc.chatlog.repositories.mongo.user&quot;</span>],</span></span><br><span class="line"><span class="meta">    mongoTemplateRef = <span class="meta-string">&quot;second-template&quot;</span></span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line"><span class="comment">//@EnableMongoRepositories(includeFilters = [ComponentScan.Filter(type = FilterType.REGEX, pattern = [&quot;.*UserMongoRepository&quot;])])</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MongoConfigSecond</span> : <span class="type">AbstractMongoClientConfiguration</span></span>() &#123;</span><br><span class="line">    <span class="meta">@Bean(<span class="meta-string">&quot;second-database&quot;</span>)</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getDatabaseName</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;not_exist&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(<span class="meta-string">&quot;second-template&quot;</span>)</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">mongoTemplate</span><span class="params">(databaseFactory: <span class="type">MongoDatabaseFactory</span>, converter: <span class="type">MappingMongoConverter</span>)</span></span>: MongoTemplate &#123;</span><br><span class="line">        <span class="keyword">return</span> MongoTemplate(mongoClient(),databaseName)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(<span class="meta-string">&quot;second-client&quot;</span>)</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">mongoClient</span><span class="params">()</span></span>: MongoClient &#123;</span><br><span class="line">        <span class="keyword">return</span> MongoClients.create(<span class="string">&quot;mongodb://root:example@localhost:27017&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还是用注解指定我们要scan的包或者类，注入对应repo，但是光这样还不够。</p>
<p>我们还要手动绑定<code>TemplateRef</code>，然后需要自己实现<code>mongoTemplate</code>。这是因为虽然我们只指定scan后，两个config注入对应的repo了，但是<code>databaseFactory</code>这个bean其实只有一个，生成的<code>mongoTemplate</code>也就只有一个。</p>
<p>所以我们要忽略掉<code>databaseFactory</code>，自己实现<code>mongoTemplate()</code>,手动new一个<code>mongoTemplate</code>。当然，你也可以实现<code>mongoDbFactory()</code>都是一样的效果。</p>
</div><div class="post-info">last updated: Aug 1, 2021</div><a class="post-info" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">许可协议: "署名-非商用-相同方式共享 4.0" 转载请保留原文链接及作者。</a></article></div></section><footer><nav id="pagination"><a class="prev" href="/2021/08/03/202108031930/"><span>golang中令人迷惑的切片与函数参数传递</span></a><a class="prev" href="/2021/07/31/202107311432/"><span>几种排序算法的复杂度分析</span></a></nav><div class="copyright"><span id="jinrishici-sentence">正在加载今日诗词....</span><script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js"></script><p>© 2015 - 2021 <a href="https://coolrc.me">coolrc</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div></body></html>