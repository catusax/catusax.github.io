<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#4fc08d"><meta name="msapplication-TileColor" content="#4fc08d"><title> 继续研究下kotlin的注解和反射 · Just4fun</title><meta name="description" content="继续研究下kotlin的注解和反射 - coolrc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://coolrc.me/atom.xml" title="Just4fun"><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-71864657-1",'auto');ga('send','pageview');</script><script src="//code.jquery.com/jquery-2.2.0.min.js"></script><link rel="stylesheet" href="/css/jquery.fancybox.min.css"><script src="/js/jquery.fancybox.min.js"></script><script src="/js/wrapimage.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Just4fun" type="application/atom+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="/friends/" target="_self">LINKS</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/coolrc136" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">继续研究下kotlin的注解和反射</h1><div class="post-info">Jul 29, 2021</div><div class="post-content"><p><a href="/2021/07/28/202107282228/">上一篇文章</a>已经介绍了java的注解和反射，这篇文章来看看kotlin里面的注解和反射。</p>
<span id="more"></span>

<h2 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h2><p>kotlin立面定义注解的语法和Java略有不同，不过基本上还是差不多的。<br>先看上篇文章的那个Java版本注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义注解</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Target(&#123;METHOD,FIELD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="meta">@interface</span> MyAnno &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用idea把他自动转换成kotlin代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义注解</span></span><br><span class="line"><span class="meta">@MustBeDocumented</span></span><br><span class="line"><span class="meta">@Target(</span></span><br><span class="line"><span class="meta">    AnnotationTarget.FUNCTION,</span></span><br><span class="line"><span class="meta">    AnnotationTarget.PROPERTY_GETTER,</span></span><br><span class="line"><span class="meta">    AnnotationTarget.PROPERTY_SETTER,</span></span><br><span class="line"><span class="meta">    AnnotationTarget.FIELD</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@Retention(AnnotationRetention.RUNTIME)</span></span><br><span class="line"><span class="keyword">annotation</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAnno</span></span>(<span class="keyword">val</span> value: String = <span class="string">&quot;hello&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>kotlin同样是四个元注解：</p>
<blockquote>
<ul>
<li>@Target 指定可以用该注解标注的元素的可能的类型（类、函数、属性、表达式等）；</li>
<li>@Retention 指定该注解是否存储在编译后的 class 文件中，以及它在运行时能否通过反射可见 （默认都是 true）；</li>
<li>@Repeatable 允许在单个元素上多次使用相同的该注解；</li>
<li>@MustBeDocumented 指定该注解是公有 API 的一部分，并且应该包含在生成的 API 文档中显示的类或方法的签名中。</li>
</ul>
</blockquote>
<p><code>@Target</code>增加了<code>PROPERTY_GETTER</code>和<code>PROPERTY_SETTER</code>，kotlin里面这些分的更细了，而且多个参数不需要大括号了，更方便。</p>
<p>注解的定义和属性换成了kotlin的格式，这个也很容易看明白。Java里是@interface定义注解，kotlin里注解其实和class格式一样了，只不过用<code>annotation</code>关键字声明他是注解。</p>
<p>还有一个好处是，kotlin注解是一个类，所以使用时候可以按照构造函数的使用方法来使用，按顺序填入参数就行了，不用加参数名。</p>
<h2 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h2><p>接下来看反射，与Java不同的是，Java是一种纯面向对象的语言，所有东西都在类里面，所以我们要反射都是从一个类开始的。但是Kotlin还支持函数式编程，类之外还有函数和属性这些东西，所以kotlin中反射不止有类似Java的Class，还有其他的类型，kotlin文档对于反射的介绍是这样的：</p>
<blockquote>
<p>反射是这样的一组语言和库功能，它允许在运行时自省你的程序的结构。 Kotlin 让语言中的函数和属性做为一等公民、并对其自省（即在运行时获悉一个名称或者一个属性或函数的类型）与简单地使用函数式或响应式风格紧密相关。</p>
</blockquote>
<h3 id="使用Java的反射API"><a href="#使用Java的反射API" class="headerlink" title="使用Java的反射API"></a>使用Java的反射API</h3><p>要在kotlin里使用Java的反射，只要这样获取Java类引用就行：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> cls = MyClass::<span class="keyword">class</span>.java</span><br></pre></td></tr></table></figure>

<h3 id="使用kotlin官方的反射"><a href="#使用kotlin官方的反射" class="headerlink" title="使用kotlin官方的反射"></a>使用kotlin官方的反射</h3><p>使用反射首先添加反射的依赖：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">  implementation(<span class="string">&quot;org.jetbrains.kotlin:kotlin-reflect:1.4.20&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要获取类引用这样</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> c = MyClass::<span class="class"><span class="keyword">class</span></span></span><br></pre></td></tr></table></figure>

<p>关于函数和属性引用可以看文档:<a target="_blank" rel="noopener" href="https://www.kotlincn.net/docs/reference/reflection.html">https://www.kotlincn.net/docs/reference/reflection.html</a></p>
<p>还是和上篇文章一样，我们来写一个反射函数处理刚才的注解：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//测试类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnnoTest</span></span>()&#123;</span><br><span class="line">    <span class="meta">@MyAnno(<span class="meta-string">&quot;testtttttt&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> name:String</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mail:String=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@MyAnno(<span class="meta-string">&quot;testtttttt2222&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">setMail</span><span class="params">(mail: <span class="type">String</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mail=mail</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;AnnoTest(name=&#x27;<span class="variable">$name</span>&#x27;, mail=&#x27;<span class="variable">$mail</span>&#x27;)&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">reflect</span><span class="params">(myAnno: <span class="type">Any</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">val</span> cls = myAnno::<span class="class"><span class="keyword">class</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//所有字段</span></span><br><span class="line">    <span class="keyword">val</span> fields = cls.declaredMemberProperties</span><br><span class="line">    <span class="keyword">for</span> (field <span class="keyword">in</span> fields)&#123;</span><br><span class="line">        <span class="comment">//直接修改字段</span></span><br><span class="line">        <span class="keyword">val</span> anno = field.findAnnotation&lt;MyAnno&gt;()</span><br><span class="line">        <span class="keyword">if</span> (anno != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="meta">@Suppress(<span class="meta-string">&quot;UNCHECKED_CAST&quot;</span>)</span></span><br><span class="line">            <span class="keyword">val</span> mutfield = field <span class="keyword">as</span> KMutableProperty1&lt;Any,Any&gt;</span><br><span class="line">            mutfield.isAccessible = <span class="literal">true</span></span><br><span class="line">            mutfield.<span class="keyword">set</span>(myAnno,anno.value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用set方法</span></span><br><span class="line">    <span class="keyword">val</span> funcs = cls.functions</span><br><span class="line">    <span class="keyword">for</span> (func <span class="keyword">in</span> funcs)&#123;</span><br><span class="line">        <span class="keyword">val</span> anno = func.findAnnotation&lt;MyAnno&gt;()</span><br><span class="line">        <span class="keyword">if</span> (anno !=<span class="literal">null</span>)&#123;</span><br><span class="line">            func.call(myAnno,anno.value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还是和上次一样，我们的反射函数针对方法和属性进行注入，运行一下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="keyword">val</span> annoTest = AnnoTest()</span><br><span class="line">    reflect(annoTest)</span><br><span class="line">    println(annoTest)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// out</span></span><br><span class="line">AnnoTest(name=<span class="string">&#x27;testtttttt&#x27;</span>, mail=<span class="string">&#x27;testtttttt2222&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>成功注入！</p>
<h2 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h2><p>既然两个反射都能用，两个都是编译成jvm字节码了，那么试试在Java里读取下注解：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="keyword">val</span> annoTest = AnnoTest()</span><br><span class="line">    <span class="keyword">val</span> cls = annoTest::<span class="keyword">class</span>.java</span><br><span class="line">    <span class="keyword">val</span> fields = cls.fields</span><br><span class="line">    <span class="keyword">for</span> (field <span class="keyword">in</span> fields)&#123;</span><br><span class="line">        <span class="keyword">val</span> anno =field.getAnnotation(MyAnno::<span class="keyword">class</span>.java)</span><br><span class="line">        <span class="keyword">if</span> (anno!=<span class="literal">null</span>)&#123;</span><br><span class="line">            println(anno.value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行之后没有输出，我们的注解没有被读到。怎么回事呢。</p>
<p>试试读出所有的注解：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> annoTest = AnnoTest()</span><br><span class="line">    <span class="keyword">val</span> cls = annoTest::<span class="keyword">class</span>.java</span><br><span class="line">    <span class="keyword">val</span> fields = cls.fields</span><br><span class="line">    <span class="keyword">for</span> (field <span class="keyword">in</span> fields)&#123;</span><br><span class="line">        <span class="keyword">val</span> annos =field.annotations</span><br><span class="line">        <span class="keyword">for</span> (anno <span class="keyword">in</span> annos)&#123;</span><br><span class="line">            println(anno)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还是没有输出，看来我们的 字段上根本没有注解，试试读取方法的注解：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="keyword">val</span> annoTest = AnnoTest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> cls = annoTest::<span class="keyword">class</span>.java</span><br><span class="line">    <span class="keyword">val</span> fields = cls.declaredMethods</span><br><span class="line">    <span class="keyword">for</span> (field <span class="keyword">in</span> fields)&#123;</span><br><span class="line">        <span class="keyword">val</span> annos =field.annotations</span><br><span class="line">        <span class="keyword">for</span> (anno <span class="keyword">in</span> annos)&#123;</span><br><span class="line">            println(anno)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// out</span></span><br><span class="line"><span class="meta">@MyAnno(<span class="meta-string">&quot;testtttttt&quot;</span>)</span></span><br><span class="line"><span class="meta">@MyAnno(<span class="meta-string">&quot;testtttttt2222&quot;</span>)</span></span><br></pre></td></tr></table></figure>

<p>这次能看到了，看来属性的注入实际上是在set方法里了。这样的话，确实可以用Java的反射类来操作，就是用起来有点概念混乱，这两个语言里的元素不是一一对应，这么用容易出bug。</p>
</div><div class="post-info">last updated: Jul 29, 2021</div><a class="post-info" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">许可协议: "署名-非商用-相同方式共享 4.0" 转载请保留原文链接及作者。</a></article></div></section><footer><nav id="pagination"><a class="prev" href="/2021/07/29/202107291739/"><span>简单对比Java和Kotlin反射性能</span></a><a class="prev" href="/2021/07/28/202107282228/"><span>Java注解和用反射处理注解</span></a></nav><div class="copyright"><span id="jinrishici-sentence">正在加载今日诗词....</span><script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js"></script><p>© 2015 - 2021 <a href="https://coolrc.me">coolrc</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div></body></html>